<!doctype html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>综合素质评价量表</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <style>
    :root {
      --bg: #0b1220;
      --panel: rgba(255, 255, 255, 0.06);
      --panel-strong: rgba(255, 255, 255, 0.12);
      --text: #e8f0ff;
      --sub: #98b4ff;
      --primary: #3a86ff;
      --cyan: #22d3ee;
      --glow: 0 0 18px rgba(58, 134, 255, .45);
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      color: var(--text);
      background: radial-gradient(1200px 600px at 70% -10%, rgba(26, 54, 120, .35), transparent), radial-gradient(800px 400px at -10% 30%, rgba(34, 211, 238, .25), transparent), var(--bg);
      font-family: "Segoe UI", "PingFang SC", "Microsoft YaHei", Helvetica, Arial, sans-serif;
      overflow-x: hidden
    }

    .data-flow::before {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      opacity: .35;
      background: repeating-linear-gradient(120deg, rgba(47, 93, 230, .12) 0 2px, transparent 2px 10px), repeating-linear-gradient(300deg, rgba(34, 211, 238, .08) 0 2px, transparent 2px 12px);
      animation: flow 14s linear infinite
    }

    @keyframes flow {
      to {
        transform: translateX(-120px)
      }
    }

    header {
      position: relative;
      padding: 28px 24px;
      text-align: center;
      z-index: 1;
      background: linear-gradient(135deg, #2740ff, #15b2ff);
      box-shadow: var(--glow);
      border-bottom: 1px solid rgba(255, 255, 255, .12)
    }

    header h1 {
      margin: 0;
      font-size: 28px
    }

    header p {
      margin: 6px 0 0;
      color: #cfe0ff
    }

    .wrap {
      display: grid;
      grid-template-columns: 420px 1fr;
      gap: 20px;
      padding: 22px;
      max-width: 1300px;
      margin: 0 auto
    }

    .card {
      background: var(--panel);
      border: 1px solid var(--panel-strong);
      border-radius: 16px;
      box-shadow: var(--glow)
    }

    .left {
      padding: 18px
    }

    .section-title {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #dbe7ff;
      font-weight: 700;
      margin: 6px 0 16px
    }

    .section-title::before {
      content: "";
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--primary);
      box-shadow: 0 0 8px var(--primary)
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 6px
    }

    .field label {
      color: #cfe0ff
    }

    .field input[type=text] {
      background: rgba(255, 255, 255, .05);
      border: 1px solid rgba(255, 255, 255, .1);
      border-radius: 8px;
      padding: 8px 10px;
      color: var(--text)
    }

    .matrix {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      overflow: hidden;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, .08)
    }

    .matrix th,
    .matrix td {
      border-right: 1px solid rgba(255, 255, 255, .08);
      border-bottom: 1px solid rgba(255, 255, 255, .08);
      padding: 10px;
      text-align: center
    }

    .matrix thead th {
      background: linear-gradient(180deg, rgba(78, 161, 255, .22), rgba(34, 211, 238, .06));
      color: #e7f1ff
    }

    .matrix tbody th {
      background: rgba(255, 255, 255, .04);
      color: #dbe7ff;
      font-weight: 600;
      width: 120px;
      text-align: center
    }

    .matrix td {
      height: 64px
    }

    .num-wrap {
      position: relative;
      display: inline-block;
      white-space: nowrap;
    }

    .num-wrap .num {
      padding-right: 18px;
    }

    .num-wrap .pct {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      color: #cfe0ff;
      opacity: .9;
      pointer-events: none;
    }

    .num {
      width: 72px;
      max-width: 40vw;
      text-align: center;
      font-size: 18px;
      color: var(--text);
      background: rgba(255, 255, 255, .05);
      border: 1px solid rgba(255, 255, 255, .1);
      padding: 8px 10px;
      border-radius: 8px;
      outline: none
    }

    .num:focus {
      border-color: #64b5ff;
      box-shadow: 0 0 0 3px rgba(100, 181, 255, .15)
    }

    .actions {
      display: flex;
      gap: 10px;
      margin-top: 14px;
      align-items: center
    }

    .spacer {
      flex: 1
    }

    button {
      appearance: none;
      border: none;
      cursor: pointer;
      padding: 10px 14px;
      border-radius: 10px;
      color: #0b1220;
      font-weight: 700;
      background: linear-gradient(135deg, #4ea1ff, #22d3ee);
      box-shadow: 0 8px 24px rgba(46, 155, 255, .35)
    }

    button.secondary {
      color: #d7e4ff;
      background: transparent;
      border: 1px solid rgba(148, 190, 255, .35)
    }

    button:active {
      transform: translateY(1px)
    }

    button:disabled {
      filter: grayscale(.6);
      opacity: .7;
      cursor: not-allowed
    }



    .chart-card {
      padding: 10px;
      display: flex;
      flex-direction: column
    }

    #chart {
      /* Bigger radar: fit most of viewport height */
      height: clamp(600px, calc(100vh - 220px), 900px);
      width: 100%
    }

    .tips {
      margin: 4px 10px 10px;
      color: #9fb7ff;
      font-size: 12px
    }

    @media (max-width: 980px) {
      .wrap {
        grid-template-columns: 1fr
      }
    }
  </style>
</head>

<body class="data-flow">
  <header>
    <h1>综合素质评价量表</h1>
  </header>

  <main class="wrap">
    <section class="card left">
      <div class="section-title">数据录入</div>
      <div class="grid-2" style="margin-bottom:8px"></div>

      <div id="controls"></div>

      <div class="actions">
        <button id="submitBtn">提交到展示页</button>
        <button id="resetBtn" class="secondary">重置</button>
        <div class="sum-tip sub">权重合计：<span id="weightSum" class="bad">0%</span>（需等于100%才可提交）</div>
      </div>
    </section>

    <section class="card chart-card">
      <div id="chart"></div>
    </section>
  </main>

  <script>
    const dims = ["人文底蕴", "科学精神", "学会学习", "健康生活", "责任担当", "实践创新"]
    const state = { scores: Array(6).fill(0), weights: Array(6).fill(0) }
    const $ = s => document.querySelector(s)
    const controls = $('#controls')

    function buildTable () {
      const header = `
          <thead>
            <tr>
              <th style="width:96px">/</th>
              ${dims.map(d => `<th>${d}<br><span class="sub">100分</span></th>`).join('')}
            </tr>
          </thead>`
      const weightRow = `
          <tr>
            <th>成长权重</th>
            ${dims.map((_, i) => `<td><input id="weight${i}" class="num" type="number" min="0" max="100" step="1" inputmode="numeric" pattern="\\d*" value="${state.weights[i]}" /></td>`).join('')}
          </tr>`
      const scoreRow = `
          <tr>
            <th>自我评价</th>
            ${dims.map((_, i) => `<td><input id="score${i}" class="num" type="number" min="0" max="100" step="1" inputmode="numeric" pattern="\\d*" value="${state.scores[i]}" /></td>`).join('')}
          </tr>`
      return `<table class="matrix">${header}<tbody>${weightRow}${scoreRow}</tbody></table>`
    }
    controls.innerHTML = buildTable()

    function enhancePercent () {
      dims.forEach((_, i) => {
        const input = document.getElementById('weight' + i)
        if (!input) return
        const td = input.closest('td') || input.parentElement
        if (!td) return
        if (input.parentElement && input.parentElement.classList.contains('num-wrap')) return
        const wrap = document.createElement('span')
        wrap.className = 'num-wrap'
        td.insertBefore(wrap, input)
        wrap.appendChild(input)
        const pct = document.createElement('span')
        pct.className = 'pct'
        pct.textContent = '%'
        wrap.appendChild(pct)
      })
    }
    enhancePercent()

    const chart = echarts.init(document.getElementById('chart'))
    function computeWeighted () {
      const factor = 3
      return state.scores.map((v, i) => Math.round(factor * v * state.weights[i] / 100))
    }
    function computeGrowth () {
      const factor = 3
      return state.weights.map(w => Math.round(factor * (100 * (w / 100)))) // = factor * w
    }
    function sumWeights () { return state.weights.reduce((a, b) => a + b, 0) }
    function refreshSumTip () {
      const s = sumWeights()
      const el = document.getElementById('weightSum')
      el.textContent = s + "%"
      el.className = (s === 100 ? 'ok' : 'bad')
      const canSubmit = s === 100
      const tip = canSubmit ? '权重已达100%，可提交' : '成长权重合计需等于100%'
      const submit = document.getElementById('submitBtn')
      submit.disabled = !canSubmit; submit.title = tip
    }
    function render () {
      const weighted = computeWeighted()
      const growth = computeGrowth()
      chart.setOption({
        backgroundColor: 'transparent',
        legend: { top: 10, textStyle: { color: '#d7e4ff' } },
        radar: {
          shape: 'polygon', radius: '70%', indicator: dims.map(d => ({ name: d, max: 100 })), axisName: { color: '#cfe0ff', fontSize: 18 },
          splitArea: { show: false },
          axisLine: { show: false }, splitLine: { show: false }
        },
        series: [
          { name: '成长权重', type: 'radar', data: [growth], symbol: 'none', areaStyle: { color: 'rgba(58,134,255,1)' }, lineStyle: { width: 0 }, itemStyle: { color: '#3a86ff' } },
          { name: '自我评价', type: 'radar', data: [weighted], symbol: 'none', areaStyle: { color: 'rgba(255,77,79,1)' }, lineStyle: { width: 0 }, itemStyle: { color: '#ff4d4f' } }
        ]
      })
      refreshSumTip()
    }
    render()

    function clampInt (v, min, max) { v = parseInt(String(v || '').replace(/[^\d-]/g, ''), 10); if (isNaN(v)) v = 0; if (v < min) v = min; if (v > max) v = max; return v }
    // 同步输入框到内存状态，解决返回时合计显示为0的问题
    function syncStateFromInputs () {
      dims.forEach((_, i) => {
        const sv = document.getElementById('score' + i)
        const wv = document.getElementById('weight' + i)
        if (sv) state.scores[i] = clampInt(sv.value, 0, 100)
        if (wv) state.weights[i] = clampInt(wv.value, 0, 100)
      })
    }
    function preventWheelNumber (el) { el.addEventListener('wheel', e => { e.preventDefault() }, { passive: false }); el.addEventListener('keydown', e => { if (e.key === 'e' || e.key === 'E' || e.key === '+' || e.key === '-') e.preventDefault() }) }
    function attach (i) {
      const s = document.getElementById('score' + i); const w = document.getElementById('weight' + i)
      preventWheelNumber(s); preventWheelNumber(w)
      const onScore = e => { const v = clampInt(e.target.value, 0, 100); if (e.target.value != v) e.target.value = v; state.scores[i] = v; render() }
      const onWeight = e => { const v = clampInt(e.target.value, 0, 100); if (e.target.value != v) e.target.value = v; state.weights[i] = v; render() }
      s.addEventListener('input', onScore); s.addEventListener('change', onScore)
      w.addEventListener('input', onWeight); w.addEventListener('change', onWeight)
    }
    dims.forEach((_, i) => attach(i))
    // 初次加载后根据输入框值回填状态并渲染
    syncStateFromInputs(); render()

    function genId () { return (window.crypto && crypto.randomUUID) ? crypto.randomUUID() : ('radar_' + Date.now() + "_" + Math.random().toString(16).slice(2)) }
    function buildPayload () {
      const titleEl = document.getElementById('titleInput')
      const tagEl = document.getElementById('tagInput')
      const title = titleEl && titleEl.value ? titleEl.value.trim() : '综合素质雷达图'
      const tag = tagEl && tagEl.value ? tagEl.value.trim() : ''
      return { id: genId(), title, tag, dims: [...dims], scores: [...state.scores], weights: [...state.weights], weighted: computeWeighted(), submittedAt: new Date().toISOString(), version: 1 }
    }
    function goDisplay (payload) { const key = 'radarPayload:' + payload.id; localStorage.setItem(key, JSON.stringify(payload)); const url = `display.html?id=${encodeURIComponent(payload.id)}`; location.href = url }
    document.getElementById('submitBtn').addEventListener('click', () => { if (sumWeights() !== 100) { alert('请将六个权重数值调整为合计 100%'); return } const payload = buildPayload(); goDisplay(payload) })
    document.getElementById('resetBtn').addEventListener('click', () => { state.scores = Array(6).fill(0); state.weights = Array(6).fill(0); dims.forEach((_, i) => { document.getElementById('score' + i).value = 0; document.getElementById('weight' + i).value = 0 }); const ti = document.getElementById('titleInput'); if (ti) ti.value = '综合素质雷达图'; const tg = document.getElementById('tagInput'); if (tg) tg.value = ''; render() })
    window.addEventListener('resize', () => chart.resize()); refreshSumTip()

    // ===== 覆盖和增强（新需求） =====
    // 1) 取消“权重合计=100%才能提交”的逻辑
    function refreshSumTip () {
      const s = sumWeights()
      const submit = document.getElementById('submitBtn')
      if (submit) {
        const canSubmit = s === 100
        submit.disabled = !canSubmit
        submit.title = canSubmit ? '' : '成长权重合计需等于 100% 才可提交'
      }
    }

    // 2) 学号仅数字；buildPayload 增加 sid 字段
    function digitsOnly (s) { return String(s || '').replace(/\D/g, '') }
    function buildPayload () {
      const titleEl = document.getElementById('titleInput')
      const tagEl = document.getElementById('tagInput')
      const sidEl = document.getElementById('studentId')
      const title = titleEl && titleEl.value ? titleEl.value.trim() : '综合素质雷达图'
      const tag = tagEl && tagEl.value ? tagEl.value.trim() : ''
      const sid = sidEl ? digitsOnly(sidEl.value) : ''
      return { id: genId(), sid, title, tag, dims: [...dims], scores: [...state.scores], weights: [...state.weights], weighted: computeWeighted(), submittedAt: new Date().toISOString(), version: 1 }
    }

    // 3) 重建操作区：左侧“输入学号”，右侧“提交/重置”
    ; (function rebuildActions () {
      const act = document.querySelector('.actions')
      if (!act) return
      act.innerHTML = `
        <label for="studentId" class="sid-label">‼️输入序号：</label>
        <input id="studentId" class="num" type="text" inputmode="numeric" pattern="\\d*" placeholder="1-35" />
        <div class="spacer"></div>
        <button id="submitBtn">提交并展示页</button>
        <button id="resetBtn" class="secondary">重置</button>
      `
      const sidInput = document.getElementById('studentId')
      if (sidInput) sidInput.addEventListener('input', (e) => {
        const v = digitsOnly(e.target.value); if (v !== e.target.value) e.target.value = v
      })
      const reset = document.getElementById('resetBtn')
      if (reset) reset.addEventListener('click', (e) => {
        e.stopImmediatePropagation()
        state.scores = Array(6).fill(0); state.weights = Array(6).fill(0)
        dims.forEach((_, i) => {
          const s = document.getElementById('score' + i); if (s) s.value = 0
          const w = document.getElementById('weight' + i); if (w) w.value = 0
        })
        const ti = document.getElementById('titleInput'); if (ti) ti.value = '综合素质雷达图'
        const tg = document.getElementById('tagInput'); if (tg) tg.value = ''
        if (sidInput) sidInput.value = ''
        render()
      }, { capture: true })
      refreshSumTip()
    })()

    // 4) 构建竖向表格（横纵交换）：维度为行，列为“成长权重 / 自我评分”
    function buildTableVertical () {
      const header = `
          <thead>
            <tr>
              <th style="width:120px">维度</th>
              <th>成长权重<br><span class="sub">%</span></th>
              <th>自我评分<br><span class="sub">100分</span></th>
            </tr>
          </thead>`
      const rows = dims.map((d, i) => `
          <tr>
            <th>${d}</th>
            <td><input id="weight${i}" class="num" type="number" min="0" max="100" step="1" inputmode="numeric" pattern="\\d*" value="${state.weights[i]}" /></td>
            <td><input id="score${i}" class="num" type="number" min="0" max="100" step="1" inputmode="numeric" pattern="\\d*" value="${state.scores[i]}" /></td>
          </tr>`).join('')
      return `<table class="matrix">${header}<tbody>${rows}</tbody></table>`
    }

    ; (function rebuildVerticalMatrix () {
      const wrap = document.getElementById('controls')
      if (!wrap) return
      wrap.innerHTML = buildTableVertical()
      enhancePercent()
      dims.forEach((_, i) => attach(i))
      syncStateFromInputs(); render(); refreshSumTip()
    })()

      // 跨设备提交：在点击提交时，先把数据发送到服务器，再跳转到展示页
      ; (function enhanceSubmitForMultiDevice () {
        const btn = document.getElementById('submitBtn')
        if (!btn) return
        btn.addEventListener('click', async (e) => {
          // 拦截原有监听，避免重复执行
          e.stopImmediatePropagation()
          if (sumWeights() !== 100) { alert('请将成长权重各项数值调整为合计 100%'); return }
          const payload = buildPayload()
          try {
            await fetch('/api/submit', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            })
          } catch (err) {
            console.warn('submit failed:', err)
          }
          const key = 'radarPayload:' + payload.id
          localStorage.setItem(key, JSON.stringify(payload))
          location.href = `display.html?id=${encodeURIComponent(payload.id)}`
        }, { capture: true })
      })()
      // 处理从展示页返回（history back / BFCache）时的状态同步
      ; (function overrideSubmitHandler () {
        const oldBtn = document.getElementById('submitBtn')
        if (!oldBtn) return
        const btn = oldBtn.cloneNode(true)
        oldBtn.parentNode.replaceChild(btn, oldBtn)
        btn.addEventListener('click', async (e) => {
          e.stopImmediatePropagation()
          if (sumWeights() !== 100) { alert('请将成长权重各项数值调整为合计 100%'); return }
          const sidEl = document.getElementById('studentId'); const sidVal = sidEl ? digitsOnly(sidEl.value) : ''
          if (!sidVal) { alert('请填写学号（1-35，仅数字）'); return }
          const sidNum = parseInt(sidVal, 10)
          if (!(sidNum >= 1 && sidNum <= 35)) { alert('学号需为 1-35 之间的整数'); return }
          const payload = buildPayload()
          try {
            await fetch('/api/submit', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            })
          } catch (err) {
            console.warn('submit failed:', err)
          }
          const key = 'radarPayload:' + payload.id
          localStorage.setItem(key, JSON.stringify(payload))
          location.href = `display.html?id=${encodeURIComponent(payload.id)}`
        }, { capture: true })
      })()
    window.addEventListener('pageshow', () => { syncStateFromInputs(); render() })
  </script>
</body>

</html>