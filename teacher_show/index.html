<!doctype html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>学生雷达图总览</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <style>
    :root {
      --bg: #0b1220;
      --panel: rgba(255, 255, 255, .06);
      --panel-strong: rgba(255, 255, 255, .12);
      --text: #e8f0ff;
      --glow: 0 0 18px rgba(58, 134, 255, .45)
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      color: var(--text);
      background: radial-gradient(1200px 600px at 70% -10%, rgba(26, 54, 120, .35), transparent), radial-gradient(800px 400px at -10% 30%, rgba(34, 211, 238, .25), transparent), var(--bg);
      font-family: "Segoe UI", "PingFang SC", "Microsoft YaHei", Helvetica, Arial, sans-serif;
      overflow: hidden
    }

    header {
      position: relative;
      padding: 18px 16px;
      text-align: center;
      background: linear-gradient(135deg, #2740ff, #15b2ff);
      border-bottom: 1px solid rgba(255, 255, 255, .12);
      box-shadow: var(--glow)
    }

    header h1 {
      margin: 0;
      font-size: 22px
    }

    /* clear-all button in header */
    .clear-all {
      position: absolute;
      top: 10px;
      right: 12px;
      color: #cfe0ff;
      background: rgba(255, 255, 255, .08);
      border: 1px solid rgba(148, 190, 255, .35);
      border-radius: 10px;
      padding: 6px 12px;
      cursor: pointer;
      transition: background .15s ease, transform .06s ease
    }

    .clear-all:hover {
      background: rgba(255, 255, 255, .12)
    }

    .clear-all:active {
      transform: scale(.98)
    }

    .wrap {
      height: calc(100% - 64px);
      padding: 14px;
      overflow: auto
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 12px
    }

    .card {
      background: var(--panel);
      border: 1px solid var(--panel-strong);
      border-radius: 12px;
      box-shadow: var(--glow);
      padding: 8px;
      cursor: pointer;
      transition: transform .08s ease;
      position: relative
    }

    .card:active {
      transform: scale(.995)
    }

    .thumb {
      width: 100%;
      height: 220px
    }

    .slot-index {
      position: absolute;
      top: 6px;
      left: 8px;
      background: rgba(255, 255, 255, .14);
      border: 1px solid rgba(255, 255, 255, .25);
      color: #e7f1ff;
      border-radius: 8px;
      font-size: 12px;
      line-height: 1;
      padding: 4px 6px;
      pointer-events: none;
      font-variant-numeric: tabular-nums
    }

    .empty {
      text-align: center;
      color: #9fb7ff;
      padding: 22px
    }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(6, 10, 20, .65);
      display: none;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(2px)
    }

    .modal.open {
      display: flex
    }

    .modal-box {
      width: min(92vw, 1100px);
      height: min(80vh, 720px);
      background: rgba(20, 26, 44, .96);
      border: 1px solid var(--panel-strong);
      border-radius: 14px;
      box-shadow: var(--glow);
      position: relative;
      padding: 10px
    }

    .modal-close {
      position: absolute;
      top: 8px;
      right: 10px;
      color: #cfe0ff;
      background: transparent;
      border: 1px solid rgba(148, 190, 255, .35);
      border-radius: 10px;
      padding: 6px 10px;
      cursor: pointer;
      z-index: 10;
      pointer-events: auto
    }

    #big {
      width: 100%;
      height: 100%
    }
  </style>
</head>

<body>
  <header>
    <h1>学生雷达图总览</h1>
    <button id="clearAll" class="clear-all" title="清空所有数据">一键清除</button>
  </header>
  <main class="wrap">
    <div id="empty" class="empty">等待学生提交中…（接收即展示）</div>
    <div id="grid" class="grid"></div>
  </main>
  <div id="modal" class="modal" tabindex="-1" aria-hidden="true">
    <div class="modal-box">
      <button class="modal-close" id="close">关闭</button>
      <div id="big"></div>
    </div>
  </div>
  <script>
    const grid = document.getElementById('grid')
    const empty = document.getElementById('empty')
    const modal = document.getElementById('modal')
    const bigEl = document.getElementById('big')
    let bigChart = null

    // 顺序展示：按提交时间依次追加卡片；去重按 id
    const list = [] // { id, card, el, chart, payload }
    const byId = new Map() // id -> item

    function validPayload (p) {
      if (!p || !p.id) return false
      if (!Array.isArray(p.dims) || !Array.isArray(p.scores) || !Array.isArray(p.weights)) return false
      const n = p.dims.length
      if (n === 0 || p.scores.length !== n || p.weights.length !== n) return false
      return true
    }

    function toSeries (p) {
      const dims = p.dims || []
      const weights = Array.isArray(p.weights) ? p.weights : []
      const scores = Array.isArray(p.scores) ? p.scores : []
      const factor = 3
      const growth = (weights.length === dims.length) ? weights.map(w => Math.round(factor * (100 * (w / 100)))) : [] // = factor * w
      const selfWeighted = (scores.length === dims.length && weights.length === dims.length)
        ? scores.map((v, i) => Math.round(factor * v * weights[i] / 100))
        : []
      return { growth, selfWeighted }
    }

    function renderThumb (el, p) {
      const chart = echarts.init(el)
      const { growth, selfWeighted } = toSeries(p)
      chart.setOption({
        backgroundColor: 'transparent',
        legend: { show: false },
        radar: {
          shape: 'polygon', radius: '70%',
          indicator: (p.dims || []).map(n => ({ name: n, max: 100 })),
          axisName: { color: '#cfe0ff', fontSize: 12 },
          splitArea: { show: false },
          axisLine: { show: false },
          splitLine: { show: false }
        },
        series: [
          { type: 'radar', data: [growth], symbol: 'none', areaStyle: { color: 'rgba(58,134,255,1)' }, lineStyle: { width: 0 }, itemStyle: { color: '#3a86ff' } },
          { type: 'radar', data: [selfWeighted], symbol: 'none', areaStyle: { color: 'rgba(255,77,79,1)' }, lineStyle: { width: 0 }, itemStyle: { color: '#ff4d4f' } }
        ]
      })
      return chart
    }

    function openModal (p) {
      if (!p) return
      if (bigChart) { try { bigChart.dispose() } catch (e) { } bigChart = null }
      bigChart = echarts.init(bigEl)
      const { growth, selfWeighted } = toSeries(p)
      bigChart.setOption({
        backgroundColor: 'transparent',
        legend: { top: 10, textStyle: { color: '#d7e4ff' } },
        radar: {
          shape: 'polygon', radius: '70%',
          indicator: (p.dims || []).map(n => ({ name: n, max: 100 })),
          axisName: { color: '#cfe0ff', fontSize: 18 },
          splitArea: { show: false },
          axisLine: { show: false },
          splitLine: { show: false }
        },
        series: [
          { name: '成长权重', type: 'radar', data: [growth], symbol: 'none', areaStyle: { color: 'rgba(58,134,255,1)' }, lineStyle: { width: 0 }, itemStyle: { color: '#3a86ff' } },
          { name: '自我评价', type: 'radar', data: [selfWeighted], symbol: 'none', areaStyle: { color: 'rgba(255,77,79,1)' }, lineStyle: { width: 0 }, itemStyle: { color: '#ff4d4f' } }
        ]
      })
      modal.classList.add('open')
      setTimeout(() => { if (bigChart) bigChart.resize() }, 60)
    }

    function closeModal () {
      modal.classList.remove('open')
      if (bigChart) { try { bigChart.dispose() } catch (e) { } bigChart = null }
    }

    document.getElementById('close').addEventListener('click', closeModal)
    modal.addEventListener('click', (e) => { if (e.target === modal) closeModal() })

    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal() })


    function clearAllUI () {
      for (const it of list) {
        if (it.chart) { try { it.chart.dispose() } catch (e) { } it.chart = null }
      }
      list.length = 0
      byId.clear()
      grid.innerHTML = ''
      empty.style.display = ''
    }

    async function clearAllData () {
      if (!confirm('确定清除所有数据吗？该操作不可恢复。')) return
      // 1) clear local UI and storage
      closeModal()
      clearAllUI()
      try {
        const keys = Object.keys(localStorage).filter(k => k.startsWith('radarPayload:'))
        for (const k of keys) localStorage.removeItem(k)
      } catch (e) { console.warn('localStorage clear failed:', e) }
      // 2) ask server (if available) to clear in-memory store
      try { await fetch('/api/clear', { method: 'POST' }) } catch (e) { /* silent */ }
      // 3) small feedback
      const btn = document.getElementById('clearAll')
      if (btn) {
        const orig = btn.textContent
        btn.disabled = true
        btn.textContent = '已清除'
        setTimeout(() => { btn.disabled = false; btn.textContent = orig }, 1000)
      }
    }

    document.getElementById('clearAll').addEventListener('click', clearAllData)


    function ensureNotEmpty () { empty.style.display = 'none' }

    function addItem (p) {
      if (!validPayload(p)) return
      ensureNotEmpty()
      // 若已存在相同 id，则刷新其图表与学号标签，避免重复追加
      if (byId.has(p.id)) {
        const it = byId.get(p.id)
        if (it.chart) { try { it.chart.dispose() } catch (e) { } it.chart = null }
        // 更新学号徽标
        const badge = it.card.querySelector('.slot-index')
        const sidText = (p.sid && String(p.sid).trim()) ? String(p.sid).trim() : '-'
        if (badge) badge.textContent = sidText
        it.chart = renderThumb(it.el, p)
        it.payload = p
        it.card.onclick = () => openModal(p)
        return
      }
      // 新增卡片
      const card = document.createElement('div')
      card.className = 'card'
      const badge = document.createElement('span')
      badge.className = 'slot-index'
      const sidText = (p.sid && String(p.sid).trim()) ? String(p.sid).trim() : '-'
      badge.textContent = sidText
      card.appendChild(badge)
      const el = document.createElement('div')
      el.className = 'thumb'
      card.appendChild(el)
      grid.appendChild(card)
      const chart = renderThumb(el, p)
      const item = { id: p.id, card, el, chart, payload: p }
      list.push(item)
      byId.set(p.id, item)
      card.onclick = () => openModal(p)
    }

    function tryParse (raw) { try { return JSON.parse(raw) } catch { return null } }

    async function preloadFromServer () {
      try {
        const r = await fetch('/api/list')
        const j = await r.json().catch(() => null)
        if (j && j.ok && Array.isArray(j.data)) {
          // 服务器已按 submittedAt 升序排序，这里直接按顺序追加
          for (const p of j.data) addItem(p)
        }
      } catch (e) {
        console.warn('server list failed:', e)
      }
    }

    function connectWS () {
      try {
        const proto = location.protocol === 'https:' ? 'wss' : 'ws'
        const url = `${proto}://${location.host}/ws`
        const ws = new WebSocket(url)
        ws.onmessage = (ev) => {
          try {
            const msg = JSON.parse(ev.data)
            if (!msg || !msg.type) return
            if (msg.type === 'payload' && msg.data) addItem(msg.data)
            if (msg.type === 'clear') clearAllUI()
          } catch { }
        }
        ws.onclose = () => { setTimeout(connectWS, 3000) }
      } catch (e) { console.warn('ws failed:', e) }
    }

    // 先尝试从服务器预加载；若失败，再回退到本地存储（同浏览器多标签场景）
    preloadFromServer().then(() => { connectWS() })

      ; (function preloadFromLocalStorage () {
        // 本地存储顺序不确定；按 submittedAt 升序排序后追加
        const keys = Object.keys(localStorage).filter(k => k.startsWith('radarPayload:'))
        const arr = []
        for (const k of keys) {
          const p = tryParse(localStorage.getItem(k))
          if (p && validPayload(p)) arr.push(p)
        }
        arr.sort((a, b) => (Date.parse(a.submittedAt || '') || 0) - (Date.parse(b.submittedAt || '') || 0))
        for (const p of arr) addItem(p)
      })()

    window.addEventListener('storage', (e) => {
      if (!e.key || !e.key.startsWith('radarPayload:')) return
      const p = tryParse(e.newValue)
      if (p) addItem(p)
    })

    window.addEventListener('resize', () => {
      for (const it of list) { if (it && it.chart) { try { it.chart.resize() } catch (e) { } } }
      if (bigChart) bigChart.resize()
    })
  </script>
</body>

</html>
